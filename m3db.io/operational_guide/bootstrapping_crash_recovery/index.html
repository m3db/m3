


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.3">
    
    
      
        <title>Bootstrapping & Crash Recovery - M3 Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.947af8d5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bootstrapping-crash-recovery" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="M3 Documentation" class="md-header-nav__button md-logo" aria-label="M3 Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            M3 Documentation
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Bootstrapping & Crash Recovery
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/m3db/m3/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    m3db/m3
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="M3 Documentation" class="md-nav__button md-logo" aria-label="M3 Documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    M3 Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/m3db/m3/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    m3db/m3
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Overview
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Overview" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/components/" title="Components" class="md-nav__link">
      Components
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/motivation/" title="Motivation" class="md-nav__link">
      Motivation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/media/" title="Media" class="md-nav__link">
      Media
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/roadmap/" title="Roadmap" class="md-nav__link">
      Roadmap
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      M3DB
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="M3DB" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        M3DB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Architecture
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/engine/" title="Storage Engine" class="md-nav__link">
      Storage Engine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/sharding/" title="Sharding and Replication" class="md-nav__link">
      Sharding and Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/consistencylevels/" title="Consistency Levels" class="md-nav__link">
      Consistency Levels
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/storage/" title="Storage" class="md-nav__link">
      Storage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/commitlogs/" title="Commit Logs" class="md-nav__link">
      Commit Logs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/peer_streaming/" title="Peer Streaming" class="md-nav__link">
      Peer Streaming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3db/architecture/caching/" title="Caching" class="md-nav__link">
      Caching
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      M3 Coordinator
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="M3 Coordinator" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        M3 Coordinator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3coordinator/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      API
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="API" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3coordinator/api/remote/" title="Prometheus Remote Write/Read" class="md-nav__link">
      Prometheus Remote Write/Read
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      M3 Query
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="M3 Query" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        M3 Query
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Configuration
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Configuration" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Configuration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/config/" title="Query Engine" class="md-nav__link">
      Query Engine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/config/annotated_config/" title="Annotated Config File" class="md-nav__link">
      Annotated Config File
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      API
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="API" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/api/" title="Query" class="md-nav__link">
      Query
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Architecture
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/blocks/" title="Blocks" class="md-nav__link">
      Blocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/fanout/" title="Query Fanout" class="md-nav__link">
      Query Fanout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../m3query/architecture/functions/" title="Function Processing" class="md-nav__link">
      Function Processing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      How-To's
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="How-To's" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        How-To's
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../how_to/single_node/" title="M3DB Single Node Deployment" class="md-nav__link">
      M3DB Single Node Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how_to/cluster_hard_way/" title="M3DB Cluster Deployment, Manually" class="md-nav__link">
      M3DB Cluster Deployment, Manually
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how_to/kubernetes/" title="M3DB on Kubernetes" class="md-nav__link">
      M3DB on Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how_to/query/" title="M3Query" class="md-nav__link">
      M3Query
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how_to/aggregator/" title="M3Aggregator" class="md-nav__link">
      M3Aggregator
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how_to/use_as_tsdb/" title="Use M3DB as a general purpose time series database" class="md-nav__link">
      Use M3DB as a general purpose time series database
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Operational Guides
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Operational Guides" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Operational Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../replication_and_deployment_in_zones/" title="Replication and Deployment in Zones" class="md-nav__link">
      Replication and Deployment in Zones
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../upgrading_m3/" title="Upgrading M3" class="md-nav__link">
      Upgrading M3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../resource_limits/" title="Resource Limits and Preventing Abusive Reads/Writes" class="md-nav__link">
      Resource Limits and Preventing Abusive Reads/Writes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../availability_consistency_durability/" title="Tuning Availability, Consistency, and Durability" class="md-nav__link">
      Tuning Availability, Consistency, and Durability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../placement/" title="Placement/Topology" class="md-nav__link">
      Placement/Topology
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../placement_configuration/" title="Placement/Topology Configuration" class="md-nav__link">
      Placement/Topology Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../namespace_configuration/" title="Namespace Configuration" class="md-nav__link">
      Namespace Configuration
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Bootstrapping & Crash Recovery
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Bootstrapping & Crash Recovery" class="md-nav__link md-nav__link--active">
      Bootstrapping & Crash Recovery
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrappers" class="md-nav__link">
    Bootstrappers
  </a>
  
    <nav class="md-nav" aria-label="Bootstrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystem-bootstrapper" class="md-nav__link">
    Filesystem Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commitlog-bootstrapper" class="md-nav__link">
    Commitlog Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#peers-bootstrapper" class="md-nav__link">
    Peers Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uninitialized-topology-bootstrapper" class="md-nav__link">
    Uninitialized Topology Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-operational-all-bootstrapper" class="md-nav__link">
    No Operational All Bootstrapper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrappers-configuration" class="md-nav__link">
    Bootstrappers Configuration
  </a>
  
    <nav class="md-nav" aria-label="Bootstrappers Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystemcommitlogpeersuninitialized_topology-default" class="md-nav__link">
    filesystem,commitlog,peers,uninitialized_topology (default)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filesystempeersuninitialized_topology" class="md-nav__link">
    filesystem,peers,uninitialized_topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#peersuninitialized_topology" class="md-nav__link">
    peers,uninitialized_topology
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invalid-bootstrappers-configuration" class="md-nav__link">
    Invalid bootstrappers configuration
  </a>
  
    <nav class="md-nav" aria-label="Invalid bootstrappers configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystemcommitloguninitialized_topology" class="md-nav__link">
    filesystem,commitlog,uninitialized_topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filesystemuninitialized_topology" class="md-nav__link">
    filesystem,uninitialized_topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commitloguninitialized_topology" class="md-nav__link">
    commitlog,uninitialized_topology
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crash-recovery" class="md-nav__link">
    Crash Recovery
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kernel_configuration/" title="Docker & Kernel Configuration" class="md-nav__link">
      Docker & Kernel Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../etcd/" title="etcd" class="md-nav__link">
      etcd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mapping_rollup/" title="Configuring Mapping & Rollup Rules" class="md-nav__link">
      Configuring Mapping & Rollup Rules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../upgrading_m3/" title="Upgrading M3" class="md-nav__link">
      Upgrading M3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../repairs/" title="Repairs" class="md-nav__link">
      Repairs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../replication_between_clusters/" title="Replication Between Clusters" class="md-nav__link">
      Replication Between Clusters
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Integrations
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Integrations" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Integrations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/prometheus/" title="Prometheus" class="md-nav__link">
      Prometheus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/graphite/" title="Graphite" class="md-nav__link">
      Graphite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/grafana/" title="Grafana" class="md-nav__link">
      Grafana
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrations/influxdb/" title="InfluxDB" class="md-nav__link">
      InfluxDB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faqs/" title="FAQs" class="md-nav__link">
      FAQs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../misc/writing_docs/" title="Tips For Writing Documentation" class="md-nav__link">
      Tips For Writing Documentation
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrappers" class="md-nav__link">
    Bootstrappers
  </a>
  
    <nav class="md-nav" aria-label="Bootstrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystem-bootstrapper" class="md-nav__link">
    Filesystem Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commitlog-bootstrapper" class="md-nav__link">
    Commitlog Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#peers-bootstrapper" class="md-nav__link">
    Peers Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uninitialized-topology-bootstrapper" class="md-nav__link">
    Uninitialized Topology Bootstrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-operational-all-bootstrapper" class="md-nav__link">
    No Operational All Bootstrapper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrappers-configuration" class="md-nav__link">
    Bootstrappers Configuration
  </a>
  
    <nav class="md-nav" aria-label="Bootstrappers Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystemcommitlogpeersuninitialized_topology-default" class="md-nav__link">
    filesystem,commitlog,peers,uninitialized_topology (default)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filesystempeersuninitialized_topology" class="md-nav__link">
    filesystem,peers,uninitialized_topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#peersuninitialized_topology" class="md-nav__link">
    peers,uninitialized_topology
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invalid-bootstrappers-configuration" class="md-nav__link">
    Invalid bootstrappers configuration
  </a>
  
    <nav class="md-nav" aria-label="Invalid bootstrappers configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystemcommitloguninitialized_topology" class="md-nav__link">
    filesystem,commitlog,uninitialized_topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filesystemuninitialized_topology" class="md-nav__link">
    filesystem,uninitialized_topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commitloguninitialized_topology" class="md-nav__link">
    commitlog,uninitialized_topology
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crash-recovery" class="md-nav__link">
    Crash Recovery
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/m3db/m3/edit/master/docs/operational_guide/bootstrapping_crash_recovery.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="bootstrapping-crash-recovery">Bootstrapping &amp; Crash Recovery</h1>
<h2 id="introduction">Introduction</h2>
<p>We recommend reading the <a href="../placement/">placement operational guide</a> before reading the rest of this document.</p>
<p>When an M3DB node is turned on (goes through a placement change) it needs to go through a bootstrapping process to determine the integrity of data that it has, replay writes from the commit log, and/or stream missing data from its peers. In most cases, as long as you're running with the default and recommended bootstrapper configuration of: <code>filesystem,commitlog,peers,uninitialized_topology</code> then you should not need to worry about the bootstrapping process at all and M3DB will take care of doing the right thing such that you don't lose data and consistency guarantees are met. Note that the order of the configured bootstrappers <em>does</em> matter.</p>
<p>Generally speaking, we recommend that operators do not modify the bootstrappers configuration, but in the rare case that you to, this document is designed to help you understand the implications of doing so.</p>
<p>M3DB currently supports 5 different bootstrappers:</p>
<ol>
<li><code>filesystem</code></li>
<li><code>commitlog</code></li>
<li><code>peers</code></li>
<li><code>uninitialized_topology</code></li>
<li><code>noop-all</code></li>
</ol>
<p>When the bootstrapping process begins, M3DB nodes need to determine two things:</p>
<ol>
<li>What shards the bootstrapping node should bootstrap, which can be determined from the cluster placement.</li>
<li>What time-ranges the bootstrapping node needs to bootstrap those shards for, which can be determined from the namespace retention.</li>
</ol>
<p>For example, imagine a M3DB node that is responsible for shards 1, 5, 13, and 25 according to the cluster placement. In addition, it has a single namespace called "metrics" with a retention of 48 hours. When the M3DB node is started, the node will determine that it needs to bootstrap shards 1, 5, 13, and 25 for the time range starting at the current time and ending 48 hours ago. In order to obtain all this data, it will run the configured bootstrappers in the specified order. Every bootstrapper will notify the bootstrapping process of which shard/ranges it was able to bootstrap and the bootstrapping process will continue working its way through the list of bootstrappers until all the shards/ranges required have been marked as fulfilled. Otherwise the M3DB node will fail to start.</p>
<h2 id="bootstrappers">Bootstrappers</h2>
<h3 id="filesystem-bootstrapper">Filesystem Bootstrapper</h3>
<p>The <code>filesystem</code> bootstrapper's responsibility is to determine which immutable <a href="../../m3db/architecture/storage/">Fileset files</a> exist on disk, and if so, mark them as fulfilled. The <code>filesystem</code> bootstrapper achieves this by scanning M3DB's directory structure and determining which Fileset files exist on disk. Unlike the other bootstrappers, the <code>filesystem</code> bootstrapper does not need to load any data into memory, it simply verifies the checksums of the data on disk and other components of the M3DB node will handle reading (and caching) the data dynamically once it begins to serve reads.</p>
<h3 id="commitlog-bootstrapper">Commitlog Bootstrapper</h3>
<p>The <code>commitlog</code> bootstrapper's responsibility is to read the commitlog and snapshot (compacted commitlogs) files on disk and recover any data that has not yet been written out as an immutable Fileset file. Unlike the <code>filesystem</code> bootstrapper, the commit log bootstrapper cannot simply check which files are on disk in order to determine if it can satisfy a bootstrap request. Instead, the <code>commitlog</code> bootstrapper determines whether it can satisfy a bootstrap request using a simple heuristic.</p>
<p>On a shard-by-shard basis, the <code>commitlog</code> bootstrapper will consult the cluster placement to see if the node it is running on has ever achieved the <code>Available</code> status for the specified shard. If so, then the commit log bootstrapper should have all the data since the last Fileset file was flushed and will return that it can satisfy any time range for that shard. In other words, the commit log bootstrapper is all-or-nothing for a given shard: it will either return that it can satisfy any time range for a given shard or none at all. In addition, the <code>commitlog</code> bootstrapper <em>assumes</em> it is running after the <code>filesystem</code> bootstrapper. M3DB will not allow you to run with a configuration where the <code>filesystem</code> bootstrapper is placed after the <code>commitlog</code> bootstrapper, but it will allow you to run the <code>commitlog</code> bootstrapper without the <code>filesystem</code> bootstrapper which can result in loss of data, depending on the workload.</p>
<h3 id="peers-bootstrapper">Peers Bootstrapper</h3>
<p>The <code>peers</code> bootstrapper's responsibility is to stream in data for shard/ranges from other M3DB nodes (peers) in the cluster. This bootstrapper is only useful in M3DB clusters with more than a single node <em>and</em> where the replication factor is set to a value larger than 1. The <code>peers</code> bootstrapper will determine whether or not it can satisfy a bootstrap request on a shard-by-shard basis by consulting the cluster placement and determining if there are enough peers to satisfy the bootstrap request. For example, imagine the following M3DB placement where node A is trying to perform a peer bootstrap:</p>
<div class="highlight"><pre><span></span><code>    ┌─────────────────┐          ┌─────────────────┐        ┌─────────────────┐
    │     Node A      │          │     Node B      │        │     Node C      │
────┴─────────────────┴──────────┴─────────────────┴────────┴─────────────────┴───
┌─────────────────────────┐   ┌───────────────────────┐   ┌──────────────────────┐
│                         │   │                       │   │                      │
│                         │   │                       │   │                      │
│  Shard 1: Initializing  │   │ Shard 1: Initializing │   │  Shard 1: Available  │
│  Shard 2: Initializing  │   │ Shard 2: Initializing │   │  Shard 2: Available  │
│  Shard 3: Initializing  │   │ Shard 3: Initializing │   │  Shard 3: Available  │
│                         │   │                       │   │                      │
│                         │   │                       │   │                      │
└─────────────────────────┘   └───────────────────────┘   └──────────────────────┘
</code></pre></div>

<p>In this case, the <code>peers</code> bootstrapper running on node A will not be able to fullfill any requests because node B is in the <code>Initializing</code> state for all of its shards and cannot fulfill bootstrap requests. This means that node A's <code>peers</code> bootstrapper cannot meet its default consistency level of majority for bootstrapping (1 &lt; 2 which is majority with a replication factor of 3). On the other hand, node A would be able to peer bootstrap its shards in the following placement because its peers (nodes B/C) have sufficient replicas of the shards it needs in the <code>Available</code> state:</p>
<div class="highlight"><pre><span></span><code>    ┌─────────────────┐          ┌─────────────────┐        ┌─────────────────┐
    │     Node A      │          │     Node B      │        │     Node C      │
────┴─────────────────┴──────────┴─────────────────┴────────┴─────────────────┴───
┌─────────────────────────┐   ┌───────────────────────┐   ┌──────────────────────┐
│                         │   │                       │   │                      │
│                         │   │                       │   │                      │
│  Shard 1: Initializing  │   │ Shard 1: Available    │   │  Shard 1: Available  │
│  Shard 2: Initializing  │   │ Shard 2: Available    │   │  Shard 2: Available  │
│  Shard 3: Initializing  │   │ Shard 3: Available    │   │  Shard 3: Available  │
│                         │   │                       │   │                      │
│                         │   │                       │   │                      │
└─────────────────────────┘   └───────────────────────┘   └──────────────────────┘
</code></pre></div>

<p>Note that a bootstrap consistency level of <code>majority</code> is the default value, but can be modified by changing the value of the key <code>m3db.client.bootstrap-consistency-level</code> in <a href="https://etcd.io/">etcd</a> to one of: <code>none</code>, <code>one</code>, <code>unstrict_majority</code> (attempt to read from majority, but settle for less if any errors occur), <code>majority</code> (strict majority), and <code>all</code>. For example, if an entire cluster with a replication factor of 3 was restarted simultaneously, all the nodes would get stuck in an infinite loop trying to peer bootstrap from each other and not achieving majority until an operator modified this value. Note that this can happen even if all the shards were in the <code>Available</code> state because M3DB nodes will reject all read requests for a shard until they have bootstrapped that shard (which has to happen everytime the node is restarted).</p>
<p><strong>Note</strong>: Any bootstrappers configuration that does not include the <code>peers</code> bootstrapper will be unable to handle dynamic placement changes of any kind.</p>
<h3 id="uninitialized-topology-bootstrapper">Uninitialized Topology Bootstrapper</h3>
<p>The purpose of the <code>uninitialized_topology</code> bootstrapper is to succeed bootstraps for all time ranges for shards that have never been completely bootstrapped (at a cluster level). This allows us to run the default bootstrapper configuration of: <code>filesystem,commitlog,peers,uninitialized_topology</code> such that the <code>filesystem</code> and <code>commitlog</code> bootstrappers are used by default in node restarts, the <code>peers</code> bootstrapper is used for node adds/removes/replaces, and bootstraps still succeed for brand new placement where both the <code>commitlog</code> and <code>peers</code> bootstrappers will be unable to succeed any bootstraps. In other words, the <code>uninitialized_topology</code> bootstrapper allows us to place the <code>commitlog</code> bootstrapper <em>before</em> the <code>peers</code> bootstrapper and still succeed bootstraps with brand new placements without resorting to using the noop-all bootstrapper which suceeds bootstraps for all shard/time-ranges regardless of the status of the placement.</p>
<p>The <code>uninitialized_topology</code> bootstrapper determines whether a placement is "new" for a given shard by counting the number of nodes in the <code>Initializing</code> state and <code>Leaving</code> states and there are more <code>Initializing</code> than <code>Leaving</code>, then it succeeds the bootstrap because that means the placement has never reached a state where all nodes are <code>Available</code>.</p>
<h3 id="no-operational-all-bootstrapper">No Operational All Bootstrapper</h3>
<p>The <code>noop-all</code> bootstrapper succeeds all bootstraps regardless of requests shards/time ranges.</p>
<h2 id="bootstrappers-configuration">Bootstrappers Configuration</h2>
<p>Now that we've gone over the various bootstrappers, let's consider how M3DB will behave in different configurations. Note that we include <code>uninitialized_topology</code> at the end of all the lists of bootstrappers because its required to get a new placement up and running in the first place, but is not required after that (although leaving it in has no detrimental effects). Also note that any configuration that does not include the <code>peers</code> bootstrapper will not be able to handle dynamic placement changes like node adds/removes/replaces.</p>
<h3 id="filesystemcommitlogpeersuninitialized_topology-default">filesystem,commitlog,peers,uninitialized_topology (default)</h3>
<p>This is the default bootstrappers configuration for M3DB and will behave "as expected" in the sense that it will maintain M3DB's consistency guarantees at all times, handle node adds/replaces/removes correctly, and still work with brand new placements / topologies. <strong>This is the only configuration that we recommend using in production</strong>.</p>
<p>In the general case, the node will use only the <code>filesystem</code> and <code>commitlog</code> bootstrappers on node startup. However, in the case of a node add/remove/replace, the <code>commitlog</code> bootstrapper will detect that it is unable to fulfill the bootstrap request (because the node has never reached the <code>Available</code> state) and defer to the <code>peers</code> bootstrapper to stream in the data.</p>
<p>Additionally, if it is a brand new placement where even the <code>peers</code> bootstrapper cannot fulfill the bootstrap, this will be detected by the <code>uninitialized_topology</code> bootstrapper which will succeed the bootstrap.</p>
<h3 id="filesystempeersuninitialized_topology">filesystem,peers,uninitialized_topology</h3>
<p>Everytime a node is restarted it will attempt to stream in all of the the data for any blocks that it has never flushed, which is generally the currently active block and possibly the previous block as well. This mode can be useful if you want to improve performance or save disk space by operating nodes without a commitlog, or want to force a repair of any unflushed blocks. This mode can lead to violations of M3DB's consistency guarantees due to the fact that commit logs are being ignored. In addition, if you lose a replication factors worth or more of hosts at the same time, the node will not be able to bootstrap unless an operator modifies the bootstrap consistency level configuration in etcd (see <code>peers</code> bootstrap section above). Finally, this mode adds additional network and resource pressure on other nodes in the cluster while one node is peer bootstrapping from them which can be problematic in catastrophic scenarios where all the nodes are trying to stream data from each other.</p>
<h3 id="peersuninitialized_topology">peers,uninitialized_topology</h3>
<p>Every time a node is restarted, it will attempt to stream in <em>all</em> of the data that it is responsible for from its peers, completely ignoring the immutable Fileset files it already has on disk. This mode can be useful if you want to improve performance or save disk space by operating nodes without a commitlog, or want to force a repair of all data on an individual node. This mode can lead to violations of M3DB's consistency guarantees due to the fact that the commit logs are being ignored. In addition, if you lose a replication factors worth or more of hosts at the same time, the node will not be able to bootstrap unless an operator modifies the bootstrap consistency level configuration in etcd (see <code>peers</code> bootstrap section above). Finally, this mode adds additional network and resource pressure on other nodes in the cluster while one node is peer bootstrapping from them which can be problematic in catastrophic scenarios where all the nodes are trying to stream data from each other.</p>
<h2 id="invalid-bootstrappers-configuration">Invalid bootstrappers configuration</h2>
<p>For the sake of completeness, we've included a short discussion below of some bootstrapping configurations that we consider "invalid" in that they are likely to lose data / violate M3DB's consistency guarantees and/or not handle placement changes in a correct way.</p>
<h3 id="filesystemcommitloguninitialized_topology">filesystem,commitlog,uninitialized_topology</h3>
<p>This bootstrapping configuration will work just fine if nodes are never added/replaced/removed, but will fail when attempting a node add/replace/remove.</p>
<h3 id="filesystemuninitialized_topology">filesystem,uninitialized_topology</h3>
<p>Every time a node is restarted it will utilize the immutable Fileset files its already written out to disk, but any data that it had received since it wrote out the last set of immutable files will be lost.</p>
<h3 id="commitloguninitialized_topology">commitlog,uninitialized_topology</h3>
<p>Every time a node is restarted it will read all the commit log and snapshot files it has on disk, but it will ignore all the data in the immutable Fileset files that it has already written.</p>
<h2 id="crash-recovery">Crash Recovery</h2>
<p><strong>NOTE:</strong> These steps should not be necessary in most cases, especially if using the default bootstrappers configuration
of <code>filesystem,commitlog,peers,uninitialized_topology</code>. However in the case the configuration is non-default or the
cluster has been down for a prolonged period of time these steps may be necessary. A good indicator would be log
messages related to failing to bootstrap from peers due to consistency issues.</p>
<p>M3DB may require manual intervention to recover in the event of a prolonged loss of quorum. This is because the <a href="#peers-bootstrapper">Peers
Boostrapper</a> must read from a majority of nodes owning a shard to bootstrap.</p>
<p>To relax this bootstrapping constraint, a value stored in etcd must be modified that corresponds to the
<code>m3db.client.bootstrap-consistency-level</code> runtime flag. Until the coordinator
<a href="https://github.com/m3db/m3/issues/1959">supports</a> an API for this, this must be done manually. The M3 contributors are
aware of how cumbersome this is and are working on this API.</p>
<p>To update this value in etcd, first determine the environment the M3DB node is using. For example in <a href="https://github.com/m3db/m3/blob/61c299dba378432de955dbff31e6c1bdd55272d7/src/dbnode/config/m3dbnode-all-config.yml#L266">this</a>
configuration, it is <code>default_env</code>. If using the M3DB Operator, the value will be <code>$KUBE_NAMESPACE/$CLUSTER_NAME</code>, where
<code>$KUBE_NAMESPACE</code> is the name of the Kubernetes namespace the cluster is located in and <code>$CLUSTER_NAME</code> is the name you
have assigned the cluster (such as <code>default/my-test-cluster</code>).</p>
<p>The following base64-encoded string represents a Protobuf-serialized <a href="https://github.com/m3db/m3/blob/61c299dba378432de955dbff31e6c1bdd55272d7/src/cluster/generated/proto/commonpb/common.proto#L40-L42">message</a> containing the string
<code>unstrict_majority</code>: <code>ChF1bnN0cmljdF9tYWpvcml0eQ==</code>. Decode this string and place it in the following etcd key, where
<code>$ENV</code> is the value determined above:</p>
<div class="highlight"><pre><span></span><code>_kv/$ENV/m3db.client.bootstrap-consistency-level
</code></pre></div>

<p>Note that on MacOS, <code>base64</code> requires the <code>-D</code> flag to decode, whereas elsewhere it is likely <code>-d</code>. Also note the use of
<code>echo -n</code> to ensure removal of newlines if your shell does not support the <code>&lt;&lt;&lt;STRING</code> pattern.</p>
<p>Once the cluster is recovered, the value should be deleted from etcd to revert to normal behavior using <code>etcdctl del</code>.</p>
<p>Examples:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># On Linux, using a recent bash, update the value for env=default_env</span>
<span class="o">&lt;&lt;&lt;</span><span class="nv">ChF1bnN0cmljdF9tYWpvcml0eQ</span><span class="o">==</span> base64 -d <span class="p">|</span> env <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl put _kv/default_env/m3db.client.bootstrap-consistency-level

<span class="c1"># On Linux, using a limited shell, update the value for env=default_env</span>
<span class="nb">echo</span> -n <span class="s2">&quot;ChF1bnN0cmljdF9tYWpvcml0eQ==&quot;</span> <span class="p">|</span> base64 -d <span class="p">|</span> env <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl put _kv/default_env/m3db.client.bootstrap-consistency-level

<span class="c1"># On MacOS, update the value for a cluster &quot;test_cluster&quot; in Kubernetes namespace &quot;m3db&quot;</span>
<span class="nb">echo</span> -n <span class="s2">&quot;ChF1bnN0cmljdF9tYWpvcml0eQ==&quot;</span> <span class="p">|</span> base64 -D <span class="p">|</span> kubectl <span class="nb">exec</span> -i <span class="nv">$ETCD_POD</span> -- env <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl put _kv/m3db/test_cluster/m3db.client.bootstrap-consistency-level

<span class="c1"># Delete the key to restore normal behavior</span>
env <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl del _kv/default_env/m3db.client.bootstrap-consistency-level
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../namespace_configuration/" title="Namespace Configuration" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Namespace Configuration
              </div>
            </div>
          </a>
        
        
          <a href="../kernel_configuration/" title="Docker & Kernel Configuration" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Docker & Kernel Configuration
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.c3dc8c49.min.js"></script>
      <script src="../../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "search.result.none": "No matching documents", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "clipboard.copied": "Copied to clipboard", "search.result.placeholder": "Type to start searching", "search.result.one": "1 matching document", "search.config.separator": "[\\s\\-]+", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>